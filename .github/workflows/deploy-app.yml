name: Deploy Application to Production

on:
  push:
    branches:
    - master
    paths-ignore:
    - '**.md'
    - '.github/**'
    - 'devops/postgresql/**'
  workflow_dispatch:


jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Application via SSH
      run: |
        ssh -tt -o  StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} -p 199 << ENDSSH
          echo "================================================"
          echo "Starting Ramadan Program Management Deployment"
          echo "Time: $(date)"
          echo "================================================"

          cd /opt/ramadan-program/ramadan-program-management-basira-org

          git --hard
          git -fd
          git checkout master
          git pull origin master          

          cat > .env << ENVEOF
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        POSTGRES_DB=${{ vars.POSTGRES_DB }}

        JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
        JWT_ACCESS_TOKEN_EXPIRES=${{ vars.JWT_ACCESS_TOKEN_EXPIRES }}

        MAIL_SERVER=${{ vars.MAIL_SERVER }}
        MAIL_PORT=${{ vars.MAIL_PORT }}
        MAIL_USE_TLS=${{ vars.MAIL_USE_TLS }}
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}

        SUPER_ADMIN_EMAIL=${{ secrets.SUPER_ADMIN_EMAIL }}
        SUPER_ADMIN_PASSWORD=${{ secrets.SUPER_ADMIN_PASSWORD }}

        ENABLE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_EMAIL_NOTIFICATIONS }}
        ENVEOF


          echo "Building and deploying with Docker Compose"
          docker compose up -d --build --force-recreate

          echo "â³ Waiting for application..."
          sleep 10

          echo "ðŸ¥ Checking application..."
          if docker ps | grep -q "ramadan_app"; then
            echo "âœ… Container is running"
            docker logs ramadan_app --tail 20
          else
            echo "âŒ Container failed to start"
            docker logs ramadan_app --tail 50
            exit 1
          fi

          echo "================================================"
          echo "âœ… Deployment completed successfully!"
          echo "Time: $(date)"
          echo "================================================"
        ENDSSH