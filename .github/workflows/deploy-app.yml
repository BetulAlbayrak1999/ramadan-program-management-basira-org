name: Deploy Application to Production

on:
  push:
    branches:
    - master
    paths-ignore:
    - '**.md'
    - '.github/**'
    - 'devops/postgresql/**'
  workflow_dispatch:


jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Application via SSH
      run: |
        ssh -o  StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} -p 199 << ENDSSH
          echo "================================================"
          echo "Starting Ramadan Program Management Deployment"
          echo "Time: $(date)"
          echo "================================================"

          cd /opt/ramadan-program/ramadan-program-management-basira-org

          echo "üì• Pulling latest code from master branch..."
          # sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org reset --hard
          # sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org clean -fd
          # sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org checkout master
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org pull origin master          
          echo "‚úÖ Pull completed"
          echo "üìù Creating .env file..."

          rm -f .env
          touch .env
          printf "DATABASE_URL=${{ secrets.DATABASE_URL }}\n" | tee .env > /dev/null
          printf "POSTGRES_DB=${{ vars.POSTGRES_DB }}\n" |  tee -a .env > /dev/null

          printf "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}\n" | tee -a .env > /dev/null
          printf "JWT_ACCESS_TOKEN_EXPIRES=${{ vars.JWT_ACCESS_TOKEN_EXPIRES }}\n" | tee -a .env > /dev/null

          printf "MAIL_SERVER=${{ vars.MAIL_SERVER }}\n" | tee -a .env > /dev/null
          printf "MAIL_PORT=${{ vars.MAIL_PORT }}\n" | tee -a .env > /dev/null
          printf "MAIL_USE_TLS=${{ vars.MAIL_USE_TLS }}\n" | tee -a .env > /dev/null
          printf "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}\n" | tee -a .env > /dev/null
          printf "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}\n" | tee -a .env > /dev/null

          printf "SUPER_ADMIN_EMAIL=${{ secrets.SUPER_ADMIN_EMAIL }}\n" | tee -a .env > /dev/null
          printf "SUPER_ADMIN_PASSWORD=${{ secrets.SUPER_ADMIN_PASSWORD }}\n" | tee -a .env > /dev/null

          printf "ENABLE_EMAIL_NOTIFICATIONS=${{ vars.ENABLE_EMAIL_NOTIFICATIONS }}\n" | tee -a .env > /dev/null

          echo "‚úÖ .env file created"

          echo "üê≥ Building and deploying with Docker Compose..."
          sudo /usr/bin/docker compose up -d --build --force-recreate

          echo "‚è≥ Waiting for application..."
          sleep 10

          echo "üè• Checking application..."
          if sudo /usr/bin/docker ps | grep -q "ramadan_app"; then
            echo "‚úÖ Container is running"
            sudo /usr/bin/docker logs ramadan_app --tail 20
          else
            echo "‚ùå Container failed to start"
            sudo /usr/bin/docker logs ramadan_app --tail 50
            exit 1
          fi

          echo "================================================"
          echo "‚úÖ Deployment completed successfully!"
          echo "Time: $(date)"
          echo "================================================"
        ENDSSH