name: Deploy PostgreSQL Database (Manual Only)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy-postgres" to confirm database deployment'
        required: true
        type: string
      recreate_volumes:
        description: 'Recreate Docker volumes? (WARNING: This will DELETE all data!)'
        required: true
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy PostgreSQL
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Validate Confirmation
      run: |
        if [ "${{ github.event.inputs.confirm }}" != "deploy-postgres" ]; then
          echo "‚ùå Deployment cancelled: confirmation text does not match"
          exit 1
        fi
        echo "‚úÖ Confirmation validated"

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy PostgreSQL via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} -p 199 << 'EOF'
          
          echo "================================================"
          echo "Starting PostgreSQL Database Deployment"
          echo "Time: $(date)"
          echo "Recreate Volumes: ${{ github.event.inputs.recreate_volumes }}"
          echo "================================================"
          
          # Navigate to project directory
          cd /opt/ramadan-program/ramadan-program-management-basira-org || exit 1
          
          echo "üì• Pulling latest code from master branch..."
          echo "Running: sudo /usr/bin/git reset --hard"
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org reset --hard
          echo "Running: sudo /usr/bin/git clean -fd"
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org clean -fd
          echo "Running: sudo /usr/bin/git fetch origin master"
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org fetch origin master
          echo "‚úÖ Fetch completed"
          echo "Running: sudo /usr/bin/git checkout master"
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org checkout master
          echo "‚úÖ Checkout completed"
          echo "Running: sudo /usr/bin/git pull origin master"
          sudo /usr/bin/git -C /opt/ramadan-program/ramadan-program-management-basira-org pull origin master
          echo "‚úÖ Pull completed"
          
          # Navigate to devops directory
          cd devops || exit 1
          
          # Stop existing PostgreSQL container if running
          echo "üõë Stopping existing PostgreSQL container..."
          sudo /usr/bin/docker compose -f /opt/ramadan-program/ramadan-program-management-basira-org/devops/docker-compose.postgres.yml down || true
          
          # Recreate volumes if requested
          if [ "${{ github.event.inputs.recreate_volumes }}" == "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Recreating volumes - ALL DATA WILL BE LOST!"
            read -p "Are you sure? This will delete all data. Press Ctrl+C to cancel, or Enter to continue..."
            
            echo "üóëÔ∏è  Removing old volumes..."
            sudo /usr/bin/docker volume rm ramadan_postgres_data ramadan_postgres_logs || true
            
            echo "üì¶ Creating new volumes..."
            sudo /usr/bin/docker volume create ramadan_postgres_logs
            sudo /usr/bin/docker volume create ramadan_postgres_data
            
            echo "üîß Setting volume permissions..."
            PG_UID=$(sudo /usr/bin/docker run --rm postgres:16-alpine id -u postgres)
            PG_GID=$(sudo /usr/bin/docker run --rm postgres:16-alpine id -g postgres)
            echo "PostgreSQL UID=$PG_UID GID=$PG_GID"
            
            sudo /usr/bin/docker run --rm -u 0:0 \
              -v ramadan_postgres_data:/var/lib/postgresql/data \
              -v ramadan_postgres_logs:/var/log/postgresql \
              alpine sh -c "chown -R $PG_UID:$PG_GID /var/lib/postgresql/data /var/log/postgresql && \
                            chmod 700 /var/lib/postgresql/data && \
                            chmod 750 /var/log/postgresql"
            
            echo "‚úÖ Volumes created and permissions set"
          else
            echo "‚ÑπÔ∏è  Using existing volumes (no data loss)"
          fi
          
          echo "üìù Creating .env file for PostgreSQL..."
          # Create .env file for PostgreSQL
          cat > .env <<-'ENVEOF'
        # PostgreSQL Configuration
        POSTGRES_DB=${{ vars.POSTGRES_DB}}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        APP_USER_PASSWORD=${{ secrets.APP_USER_PASSWORD }}
        MONITOR_USER_PASSWORD=${{ secrets.MONITOR_USER_PASSWORD }}
        ENVEOF
          
          echo "üîí Setting .env permissions..."
          chmod 600 .env
          
          echo "üê≥ Starting PostgreSQL with Docker Compose..."
          echo "Running: sudo /usr/bin/docker compose -f /opt/ramadan-program/ramadan-program-management-basira-org/devops/docker-compose.postgres.yml up -d"
          sudo /usr/bin/docker compose -f /opt/ramadan-program/ramadan-program-management-basira-org/devops/docker-compose.postgres.yml up -d
          echo "‚úÖ Docker compose command executed"
          
          echo "üìã Docker compose status:"
          sudo /usr/bin/docker compose -f /opt/ramadan-program/ramadan-program-management-basira-org/devops/docker-compose.postgres.yml ps
          
          echo "‚è≥ Waiting for PostgreSQL to be ready..."
          sleep 15
          
          echo "üìä Current running containers:"
          sudo /usr/bin/docker ps
          
          echo "üè• Checking PostgreSQL health..."
          if sudo /usr/bin/docker ps | grep -q "ramadan_postgres"; then
            echo "‚úÖ PostgreSQL container is running"
            
            # Wait for PostgreSQL to be fully ready
            echo "‚è≥ Waiting for PostgreSQL to accept connections..."
            for i in {1..30}; do
              if sudo /usr/bin/docker exec ramadan_postgres pg_isready -U postgres -d ramadan_db > /dev/null 2>&1; then
                echo "‚úÖ PostgreSQL is ready and accepting connections"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done
            
            # Show last 30 lines of logs
            echo "üìã PostgreSQL logs:"
            sudo /usr/bin/docker logs ramadan_postgres --tail 30
            
            # Show database users (excluding password hashes)
            echo ""
            echo "üë• Database users:"
            sudo /usr/bin/docker exec ramadan_postgres psql -U postgres -d ramadan_db -c "\du" || true
            
          else
            echo "‚ùå PostgreSQL container failed to start"
            sudo /usr/bin/docker logs ramadan_postgres --tail 50
            exit 1
          fi
          
          echo "================================================"
          echo "‚úÖ PostgreSQL deployment completed successfully!"
          echo "Time: $(date)"
          echo "================================================"
        EOF
    # - name: Notify Deployment Status
    #   if: always()
    #   run: |
    #     if [ "${{ job.status }}" == "success" ]; then
    #       echo "‚úÖ PostgreSQL deployment succeeded"
    #     else
    #       echo "‚ùå PostgreSQL deployment failed"
    #       exit 1
    #     fi
